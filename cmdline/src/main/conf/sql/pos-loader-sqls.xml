<?xml version = "1.0" encoding = "UTF-8"?>

<root>
	<sql:configuration xmlns:sql="http://www.auster.com.br/common/sql/">
		<sql:statements>

			<sql:statement name="posVoiceInsertQuery">
				<sql:query>
				INSERT INTO USAGE_RATES 
    				(TARIFF_ZONE_UID, PLANS_UID, SERVICES_UID, RATE_TIME_ZONE_UID, EFFECTIVE_DATE, INCOMING_FLAG, INIT_VOLUME, END_VOLUME, STEP_VOLUME, STEP_COST, LOADED_DATE)
					( 
					SELECT DISTINCT 
					       a.TARIFF_ZONE_UID, a.PLANS_UID, a.SERVICES_UID, a.RATE_TIME_ZONE_UID, a.EFFECTIVE_DATE, a.INCOMING_FLAG,
					       b.AMOUNT, c.AMOUNT, d.AMOUNT, e.AMOUNT, TRUNC(SYSDATE)
					FROM 
					    ( select TARIFF_ZONE_UID, PLANS_UID, SERVICES_UID, RATE_TIME_ZONE_UID, TO_DATE(EFFECTIVE_DATE) as EFFECTIVE_DATE, INCOMING_FLAG, STATE, max(VS) as VS
					      from TEMP_USAGE_RATES 
					      group by TARIFF_ZONE_UID, PLANS_UID, SERVICES_UID, RATE_TIME_ZONE_UID, TO_DATE(EFFECTIVE_DATE), INCOMING_FLAG, STATE) a,
					    ( select TARIFF_ZONE_UID, PLANS_UID, SERVICES_UID, RATE_TIME_ZONE_UID, TO_DATE(EFFECTIVE_DATE) as EFFECTIVE_DATE, INCOMING_FLAG, AMOUNT, VS
					      from TEMP_USAGE_RATES where RATE_TYPE = 1) d,
					    ( select TARIFF_ZONE_UID, PLANS_UID, SERVICES_UID, RATE_TIME_ZONE_UID, TO_DATE(EFFECTIVE_DATE) as EFFECTIVE_DATE, INCOMING_FLAG, AMOUNT, VS
					      from TEMP_USAGE_RATES where RATE_TYPE = 2) b,
					    ( select TARIFF_ZONE_UID, PLANS_UID, SERVICES_UID, RATE_TIME_ZONE_UID, TO_DATE(EFFECTIVE_DATE) as EFFECTIVE_DATE, INCOMING_FLAG, AMOUNT, VS 
					      from TEMP_USAGE_RATES where RATE_TYPE = 3) c,
					    ( select TARIFF_ZONE_UID, PLANS_UID, SERVICES_UID, RATE_TIME_ZONE_UID, TO_DATE(EFFECTIVE_DATE) as EFFECTIVE_DATE, INCOMING_FLAG, AMOUNT, VS
					      from TEMP_USAGE_RATES where RATE_TYPE = 4) e,
					    QLF_PLANS f
					WHERE 
					      b.TARIFF_ZONE_UID = a.TARIFF_ZONE_UID AND b.PLANS_UID = a.PLANS_UID AND  b.SERVICES_UID = a.SERVICES_UID AND 
					      b.RATE_TIME_ZONE_UID = a.RATE_TIME_ZONE_UID AND  b.EFFECTIVE_DATE = a.EFFECTIVE_DATE AND 
					      b.INCOMING_FLAG = a.INCOMING_FLAG AND b.VS = a.VS
					      AND
					      c.TARIFF_ZONE_UID = a.TARIFF_ZONE_UID AND c.PLANS_UID = a.PLANS_UID AND  c.SERVICES_UID = a.SERVICES_UID AND 
					      c.RATE_TIME_ZONE_UID = a.RATE_TIME_ZONE_UID AND  c.EFFECTIVE_DATE = a.EFFECTIVE_DATE AND 
					      c.INCOMING_FLAG = a.INCOMING_FLAG AND c.VS = a.VS
					      AND
					      d.TARIFF_ZONE_UID = a.TARIFF_ZONE_UID AND d.PLANS_UID = a.PLANS_UID AND  d.SERVICES_UID = a.SERVICES_UID AND 
					      d.RATE_TIME_ZONE_UID = a.RATE_TIME_ZONE_UID AND  d.EFFECTIVE_DATE = a.EFFECTIVE_DATE AND 
					      d.INCOMING_FLAG = a.INCOMING_FLAG AND d.VS = a.VS
					      AND
					      e.TARIFF_ZONE_UID = a.TARIFF_ZONE_UID AND e.PLANS_UID = a.PLANS_UID AND  e.SERVICES_UID = a.SERVICES_UID AND 
					      e.RATE_TIME_ZONE_UID = a.RATE_TIME_ZONE_UID AND  e.EFFECTIVE_DATE = a.EFFECTIVE_DATE AND 
					      e.INCOMING_FLAG = a.INCOMING_FLAG AND e.VS = a.VS
					      AND
					      a.PLANS_UID = f.OBJID AND a.STATE = f.STATE
					)				
 				</sql:query>
			</sql:statement>
			
			<sql:statement name="posMegatimInsertQuery">
				<sql:query>
				INSERT INTO MEGATIM_PARAMS ( OBJID, LOADED_DATE, ACTIVATION_UID, GEO_UID, ONNET_ONLY, VALID_PERIOD, INVOICE_DESCRIPTION, NEW_CUSTOMER_FEE, YET_CUSTOMER_FEE )
				(
				  SELECT LOADER_SEQ.NEXTVAL, TRUNC(SYSDATE), a.* FROM 
				  ( SELECT 
				      DISTINCT ACTIVATION_UID, GEO_UID, ONNET_ONLY, VALID_PERIOD, INVOICE_DESCRIPTION, NEW_CUSTOMER_FEE, YET_CUSTOMER_FEE
				  FROM 
				      TEMP_MEGATIM_PARAMS ) a
				  ) 
 				</sql:query>
			</sql:statement>
			
			<sql:statement name="posMegatimServicesInsertQuery">
				<sql:query>
				 INSERT INTO MEGATIM_SERVICES ( SERVICE_UID, MEGATIM_UID, PROMO_QTTY ) 
				( SELECT 
				    a.SERVICE_UID, b.OBJID, a.PROMO_QTTY  
				  FROM 
				    ( SELECT DISTINCT ACTIVATION_UID, GEO_UID, SERVICE_UID, PROMO_QTTY FROM TEMP_MEGATIM_SERVICES ) a,
				    MEGATIM_PARAMS b
				  WHERE
				    b.ACTIVATION_UID = a.ACTIVATION_UID AND 
				    b.GEO_UID = a.GEO_UID AND 
				    b.LOADED_DATE = TRUNC(SYSDATE)   
				)
 				</sql:query>
			</sql:statement>
			
		</sql:statements>
	</sql:configuration>
</root>